# NHS智能提醒系统 - 生产环境部署指南

## 🎯 系统概述

本系统是一个完整的NHS智能提醒解决方案，集成了Web界面、WhatsApp智能对话、智能提醒引擎、GP预约监控和实时NHS数据ETL等功能。

## 🚀 一键启动（生产环境）

### 唯一启动命令
```bash
start.bat
```
或
```bash
start_production.bat
```

### 首次配置（仅需一次）
系统首次启动时会自动创建配置文件，请编辑 `.env` 并填入：

```env
# WhatsApp API配置（必填）
WHATSAPP_ACCESS_TOKEN=你的永久访问令牌
WHATSAPP_PHONE_NUMBER_ID=你的电话号码ID
WHATSAPP_WEBHOOK_URL=https://你的域名.com/webhook
WHATSAPP_BUSINESS_NAME=NHS等候列表提醒服务

# 系统配置（可选，有默认值）
DATABASE_URL=sqlite:///nhs_alerts.db
API_PORT=8001
LOG_LEVEL=INFO
```

## 📁 简化的目录结构

```
prod_final/                        # 生产环境根目录
├── start.bat                      # 🎯 主启动入口
├── start_production.bat           # 生产环境启动脚本
├── main.py                        # 系统主程序（英文界面）
├── .env                           # 配置文件（自动生成）
├── 
├── # 核心功能模块
├── whatsapp_flow_service.py       # WhatsApp智能对话服务
├── intelligent_alert_engine.py    # 智能提醒引擎
├── gp_slot_monitor.py             # GP预约监控服务
├── whatsapp_config.py             # WhatsApp配置类
├── 
├── # 数据和配置
├── data_sources.py                # NHS数据源配置
├── create_db.sql                  # 数据库初始化脚本
├── nhs_alerts.db                  # 系统数据库
├── requirements.txt               # Python依赖
├── 
├── # 配置模板和文档
├── whatsapp_simple_config.env     # 配置模板
├── 简化配置说明.md               # 配置说明（中文）
├── 生产环境部署指南.md           # 本文档
├── README_business.md             # 商业化说明
├── DEPLOYMENT.md                  # 详细部署文档
└── README_COMMERCIAL.md           # 商业功能说明
```

## 🏭 集成的功能模块

### ✅ Web管理界面
- **访问地址**: http://localhost:8001
- **API文档**: http://localhost:8001/docs
- **功能**: 数据查看、系统管理、用户管理

### ✅ WhatsApp智能对话
- **4屏设置流程**: Welcome → Postcode → Specialty → Preferences
- **智能命令**: setup, status, alerts, trends, help, stop
- **自然语言**: "心脏科等候时间多久？", "我附近有更快的选择吗？"

### ✅ 8种智能提醒
1. **等候时间阈值提醒** - 超过设定时间时提醒
2. **等候时间变化提醒** - 时间显著变化时提醒
3. **更短替代方案提醒** - 发现更快选择时提醒
4. **地区异常提醒** - 地区等候时间异常时提醒
5. **趋势预测提醒** - 基于趋势的预测提醒
6. **医院容量提醒** - 医院容量变化提醒
7. **专科瓶颈提醒** - 专科资源紧张提醒
8. **个性化推荐提醒** - 基于个人偏好的推荐

### ✅ GP预约监控
- **实时监控**: 5分钟间隔检查GP空位
- **个性化匹配**: 根据用户位置和偏好
- **即时通知**: WhatsApp即时推送
- **一键预约**: 提供直接预约链接

### ✅ NHS数据ETL
- **实时数据**: 自动抓取最新NHS RTT数据
- **数据处理**: 智能清洗和标准化
- **数据存储**: SQLite数据库存储
- **API接口**: RESTful API提供数据访问

## 🌍 系统语言设置

- **系统界面**: 默认英文（面向全球用户）
- **配置文档**: 中文（便于本地配置）
- **用户交互**: 支持中英文自然语言
- **API响应**: 英文（标准化）

## 🔧 WhatsApp API配置

### 1. 获取API凭据
- 访问：https://developers.facebook.com/
- 创建应用，添加WhatsApp Business API
- 获取永久访问令牌和电话号码ID

### 2. 配置Webhook
- 回调URL：https://你的域名.com/webhook
- 验证令牌：使用默认值
- 订阅事件：messages, message_deliveries

### 3. 测试配置
系统启动后会自动验证API连接状态。

## 📊 部署后验证

### 1. 系统启动验证
```bash
# 启动系统
start.bat

# 应该看到：
# ✅ Database initialized
# ✅ WhatsApp Flow Service initialized
# ✅ Intelligent Alert Engine initialized
# ✅ GP Slot Monitor initialized
# ✅ Web server started on port 8001
# 🎉 NHS Intelligent Alert System Ready!
```

### 2. 功能验证
- **Web界面**: 访问 http://localhost:8001
- **API文档**: 访问 http://localhost:8001/docs
- **WhatsApp**: 发送消息测试对话功能
- **数据库**: 查看 nhs_alerts.db 中的数据表

### 3. 性能验证
- **响应时间**: Web API < 500ms
- **数据更新**: NHS数据每小时更新
- **提醒延迟**: < 5分钟
- **系统稳定性**: 24/7运行

## 🚨 故障排除

### 配置问题
- **检查.env文件**: 确保所有必需字段已填写
- **验证API凭据**: 测试WhatsApp API连接
- **端口冲突**: 更改API_PORT配置

### 启动问题
- **Python环境**: 确保Python 3.8+已安装
- **虚拟环境**: 系统会自动创建和激活
- **依赖安装**: 系统会自动安装所需包

### 运行问题
- **数据库错误**: 删除nhs_alerts.db让系统重建
- **网络问题**: 检查NHS API和WhatsApp API访问
- **内存不足**: 监控系统资源使用情况

## 📈 系统监控

### 日志文件
- **主日志**: nhs_alert_system.log
- **错误日志**: 控制台输出
- **API日志**: Web服务器日志

### 性能指标
- **用户数量**: 注册用户统计
- **提醒发送**: 每日提醒统计
- **API调用**: 请求量和响应时间
- **数据更新**: ETL处理统计

## 🎉 完成部署

部署完成后，您将拥有：

✅ **完整的NHS智能提醒系统**
✅ **一键启动的生产环境**
✅ **默认英文的全球化界面**
✅ **简化的配置和维护**
✅ **商业级的稳定性和性能**

---

**🚀 现在只需运行 `start.bat` 即可启动完整的NHS智能提醒系统！** 